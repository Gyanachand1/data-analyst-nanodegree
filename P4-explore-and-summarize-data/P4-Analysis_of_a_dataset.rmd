---
title: 'Project 4  : Explartion of Red Wine Quality'
author: "Isabel María Villalba Jiménez"
date: "December 6th, 2016"
output:
  bookdown::html_document2: 
    fig_caption: yes
  github_document:
    depth: 1
    fig_caption: yes
    fig_height: 6
    fig_width: 8
  html_document:
    depth: 1
    fig_caption: yes
    fig_height: 6
    fig_width: 8
  pdf_document:
    citation_package: natbib
    fig_caption: yes
    fig_height: 6
    fig_width: 7
    highlight: tango
    keep_tex: yes
link-citations: yes
bibliography: P4.bib
biblio-style: apsr
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.cap = NULL, fig.width=4, fig.height=4, fig.path='Figs/', 
                      fig.align = 'center',
                      echo=FALSE, warning=FALSE, message=FALSE, include = TRUE, results= 'hide')
```

```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
# Load all of the packages that you end up using
# in your analysis in this code chunk.


# Notice that the parameter "echo" was set to FALSE for this code chunk.
# This prevents the code from displaying in the knitted HTML output.
# You should set echo=FALSE for all code chunks in your file.
this_dir <- 'Git/data-analyst-nanodegree/P4-explore-and-summarize-data/' 
setwd("~")
setwd(this_dir)

library(ggplot2)
library(gridExtra)
# stable version on CRAN
#install.packages("bookdown")
library(bookdown)


# Captioner
# Now included in bookdown
#captioner is an R package for generating figure numbers and captions
#https://github.com/adletaw/captioner

#install.packages("devtools")
#devtools::install_github("adletaw/captioner")
#library(captioner)
```


#Analysis

In this work it will be analyzed the impact in quality of several parameters describing red wine. The dataset is curated by Udacity and comes from UCI repository [https://archive.ics.uci.edu/ml/datasets/Wine+Quality](https://archive.ics.uci.edu/ml/datasets/Wine+Quality) and consists of 1599 sample data for Red wine [https://docs.google.com/document/d/1qEcwltBMlRYZT-l699-71TzInWfk4W9q5rTCSvDVMpc/pub?embedded=true](https://docs.google.com/document/d/1qEcwltBMlRYZT-l699-71TzInWfk4W9q5rTCSvDVMpc/pub?embedded=true).

 In @cortez2009modeling it is shown that the most imporant features for assessing Red Wine quality are:
 
- sulphates

- pH

- total sulfur dioxide

# Variable summary


```{r echo=TRUE, results='markup', Load_the_Data}
# Load the Data
redwines <- read.csv('wineQualityReds.csv')

dim(redwines)
#names(redwines)
summary(redwines)

# New variables 
#redwines$quality.factor <- factor(redwines$quality)

redwines$quality.cat <- NA
redwines$quality.cat <- ifelse(redwines$quality>=7, 'good','medium')
redwines$quality.cat <- ifelse(redwines$quality<=4, 'bad',redwines$quality.cat) # if not, leave the previous values
redwines$quality.cat <- factor(redwines$quality.cat, levels = list('bad', 'medium','good')) # set the order!

print("Variables after dividing into quality groups")
str(redwines) #summary of values for each variable

#unique(redwines$quality.cat)
```

# Univariate analysis

In this section it will be analyzed each of the variables describing the wines.

## Plots Section
###Quality

The distribution of wine shows that most of wines have a quality between 5-6 points.

```{r echo=FALSE, UnivariatePlots,fig.width=3, fig.height=3,  fig.cap = "Quality distribution"}
ggplot(aes(x = quality), data = redwines) + geom_histogram(binwidth = 1, fill = "brown", color= "black") + ggtitle('Quality') +theme_light(base_size = 10)
 
#ggplot(aes(x = sulphates), data = redwines) + geom_histogram(binwidth = .02) + scale_x_log10() + ggtitle('Sulphates')

library(GGally)
#ggpairs(redwines, axisLabels = 'internal', lower = list(continous = 'points', mapping = aes(shape= quality.cat, color=quality.cat), size = 8), upper = list(continous = 'smooth', discrete = 'facetwrap', size = 8), columns=2:10) + theme_light(base_size = 8)
```

### Fixed and volatile acidity

In the next plot it is deduced that the quality of the wine is directly proportional to the fixed acidity and acid levels and inversely proportional to volatile acidity. 

```{r echo=FALSE, UnivariatePlotsacidity,fig.width=9, fig.height=3, fig.cap="Fixed and volatile acidity distributions"}
library(gridExtra)
#Fixed
p1 <- ggplot(aes(x = fixed.acidity), data = redwines) + geom_histogram(binwidth=.5, color = "black", fill = "turquoise3") + ggtitle('Fixed acidity') +  theme_light(base_size = 10) # +  scale_x_log10() #+

# Volatile
p2 <-ggplot(aes(x = volatile.acidity), data = redwines) + geom_histogram(binwidth = .05,  color = "black", fill = "turquoise3")+  scale_x_log10() + ggtitle('Volatile acidity')  + theme_light(base_size = 10)

# Citric acid
p3 <-ggplot(aes(x = citric.acid), data = redwines) + geom_histogram(binwidth = .05,  color = "black", fill = "turquoise3") + ggtitle('Citric acidity') + theme_light(base_size = 10)


grid.arrange(p1,p2, p3, ncol=3) + theme_light(base_size = 10)
```

### Residual sugar

The plot of residual suggar shows that the better the wine the higher the residual sugar levels. 

```{r echo=FALSE, UnivariatePlotsresidualsugar,fig.width=3, fig.height=3, fig.cap="Residual sugar distribution"}
#Residual sugar
p4 <- ggplot(aes(x = residual.sugar), data = redwines) + geom_histogram(binwidth=.1,  color = "black", fill = "turquoise3") +  scale_x_log10() + ggtitle('Residual sugar')  + theme_light(base_size = 10)

p4
```

### Chlorides and sulfur dioxide

In the plot of the chlorides, it can be onserved that the better the wine, the lower the chloride levels. For the sulfur dioxide, either the free or the total sulfur dioxide, high levels are indicator of medium quality, whereas bad and good wine have the same low amount of sulfure dioxide.

```{r echo=FALSE, UnivariatePlotschlorides,fig.width=9, fig.height=3, fig.cap="Chlorides and sulfur dioxide distributions"}
#Chlorides
p5 <- ggplot(aes(x = chlorides), data = redwines) + geom_histogram(binwidth=.1,  color = "black", fill = "turquoise3") +  scale_x_log10() + ggtitle('Chlorides')+ theme_light(base_size = 10)

#Free sulfur dioxide
p6 <- ggplot(aes(x = free.sulfur.dioxide), data = redwines) + geom_histogram(binwidth=.1,  color = "black", fill = "turquoise3") +  scale_x_log10() + ggtitle('Free sulfur dioxide') + theme_light(base_size = 10)

#Total sulfur dioxide
p7 <- ggplot(aes(x = total.sulfur.dioxide), data = redwines) + geom_histogram(binwidth=.1,  color = "black", fill = "turquoise3") +  scale_x_log10() + ggtitle('Total sulfur dioxide') + theme_light(base_size = 10)

grid.arrange(p5, p6, p7, ncol=3) + theme_light(base_size = 10)
```


### Density, pH, sulphates and alcohol

The next plot shows that, generally, the lower the density, the better the quality of the wine. ALso, low pH levels are sign of beter quality. The higher the sulphates level, the better quality of the wine and also, good wines have higher amount of alcohol.

```{r echo=FALSE, UnivariatePlotsdensity, fig.width=6, fig.height=6, fig.cap="Density, pH, sulphates and alcohol distributions"}
#Density
p8 <- ggplot(aes(x = density), data = redwines) + geom_histogram(binwidth=.0005,  color = "black", fill = "turquoise3") +  scale_x_log10() + ggtitle('Density')+ theme_light(base_size = 10)

#pH
p9 <- ggplot(aes(x = pH), data = redwines) + geom_histogram(binwidth=.01, color = "black", fill = "turquoise3") +  scale_x_log10() + ggtitle('pH') + theme_light(base_size = 10)

#Sulphates
p10 <- ggplot(aes(x = sulphates), data = redwines) + geom_histogram(binwidth=.05,  color = "black", fill = "turquoise3") +  scale_x_log10() + ggtitle('Sulphates')+ theme_light(base_size = 10) 

#Alcohol
p11 <- ggplot(aes(x = alcohol), data = redwines) + geom_histogram(binwidth=.01, color = "black", fill = "turquoise3") +  scale_x_log10() + ggtitle('Alcohol')+ theme_light(base_size = 10)

grid.arrange(p8, p9, p10, p11, ncol=2) + theme_light(base_size = 10);
```



## Analysis

### What is the structure of your dataset?
```{r}
summary(redwines)
colnames(redwines)
```

There are 1599 red wines with *12 features* (**fixed.acidity, volatile.acidity, citric.acid, residual.sugar, chlorides, free.sulfur.dioxide, total.sulfur.dioxide, density, pH, sulphates, alcohol** and **quality**). The variables quality is converted in a factor variable (adding a new variable named ```quality.cat```) with the following levels:



|                 | BAD  | MEDIUM | GOOD |
|:---------------:|:----:|:------:|:----:|
|```quality.cat```| [0,4]| (4,7) |[7,10]|

Table: Quality range table.

Other observations:


```{r tablequality, message=TRUE, results= "asis", echo= FALSE}
##CONVERT SUMMARY to DF and PRINT
#trasposed the table i
summary_quality <- data.frame(unclass(t(summary(redwines$quality))), check.rows = TRUE, check.names = FALSE, stringsAsFactors = FALSE, row.names= "``redwines.quality``") 
knitr::kable(summary_quality, caption = "Summary of ```redwines.quality```", row.names = TRUE)

```


Table \@ref(tab:tablequality) shows that the mean quality of the red wines is 5.636 and the median is 6. Q1 division corresponds to 5 and Q3 to 6, hence, 50% of the data lays within 5-6 range of quality, this is the level MEDIUM.


### What is/are the main feature(s) of interest in your dataset?

The main feature of interest in this dataset is the **quality** of the wine.

### What other features in the dataset do you think will help support your investigation into your feature(s) of interest?

In @cortez2009modeling it is shown that the most imporant features for assessing Red Wine quality are: **sulphates**, **pH** and **total sulfur dioxide**. An analysis will be performed in order to certify whether these are the most importart features for the analysis or others are.

### Did you create any new variables from existing variables in the dataset?

I did not create any new variables to support the analysis since the amount of information available is enough to assess the quality of the wine.

### Of the features you investigated, were there any unusual distributions? Did you perform any operations on the data to tidy, adjust, or change the form of the data? If so, why did you do this?

Most of the features had a normal distribution. Some of the them had quite skewed distributions and many oultiers and I performed a log10 tranformation in order to have a better view.  The efect of this transformation can be observed in figure \@ref(fig:univariatetranformation), where charateristics of plots in the left side are seen better after the x axis is transformed. 

```{r univariatetranformation, fig.width=6, fig.height=6, fig.cap="Residual sugar and Chlorides distributions with original and log10() transformed axis"}
#Residual sugar
p4_base <- ggplot(aes(x = residual.sugar), data = redwines) 
p4_log <- p4_base + geom_histogram(binwidth=.1,  color = "black", fill = "turquoise3") +  scale_x_log10(breaks = c(1, 2, 5, 10)) + ggtitle('Residual sugar: log10 scaled')+ theme_light(base_size = 10)

p4_normal <- p4_base + geom_histogram(binwidth=.5,  color = "black", fill = "turquoise3") + ggtitle('Residual sugar')+ theme_light(base_size = 10) 

#Chlorides
p5_base <- ggplot(aes(x = chlorides), data = redwines) 
p5_log <- p5_base + geom_histogram(binwidth=.1,  color = "black", fill = "turquoise3") +  scale_x_log10(breaks = c(.05, .1 ,.2, .5)) + ggtitle('Chlorides: log10 scaled')+ theme_light(base_size = 8)

p5_normal <- p5_base + geom_histogram(binwidth=.02,  color = "black", fill = "turquoise3") + ggtitle('Chlorides')+ theme_light(base_size = 10) 

grid.arrange(p4_normal, p4_log, p5_normal, p5_log, ncol=2) + theme_light(base_size = 10)
```



# Bivariate Analysis

##Plots Section
In this section it will be perfomed an analysis of the features vs the quality ranges.

```{r echo=FALSE, Bivariate_Plots}

```
### Fixed and volatile acidity

In the next plot (fig.\@ref(fig:bivariateplotsacidity)) it is deduced that the quality of the wine is directly proportional to the fixed acidity and acid levels and inversely proportional to volatile acidity. 


```{r bivariateplotsacidity, echo=FALSE, message= FALSE,fig.width=8, fig.height=6, fig.cap= " Fixed and volatile acidity distributions per quality segment"}
#Fixed acidity
p1_a <- ggplot(aes(x = fixed.acidity, fill= quality.cat), data = redwines) + geom_histogram(binwidth=.5, color = "black", size= 0.25) + ggtitle('Fixed acidity') + theme_light(base_size = 10) # +  scale_x_log10() #+ theme_light(base_size = 10)
p1_b <-ggplot(aes(y = fixed.acidity, x= quality.cat, fill= quality.cat), data = redwines) + geom_boxplot(outlier.alpha = 1/10) + geom_boxplot() + ggtitle('Fixed acidity') +  theme_light(base_size = 10)


# Volatile
p2_a <-ggplot(aes(x = volatile.acidity, fill= quality.cat ), data = redwines) + geom_histogram(binwidth = .05, color = "black", size= 0.25)+  scale_x_log10() + ggtitle('Volatile acidity')  + theme_light(base_size = 10)
p2_b <-ggplot(aes(y = volatile.acidity, x= quality.cat, fill= quality.cat), data = redwines) + geom_boxplot(outlier.alpha = 1/10) + geom_boxplot() + ggtitle('Volatile acidity') +  scale_y_log10() +  theme_light(base_size = 10)

# Citric acid
p3_a <-ggplot(aes(x = citric.acid, fill= quality.cat ), data = redwines) + geom_histogram(binwidth = .05, color = "black", size= 0.25) + ggtitle('Citric acidity') + theme_light(base_size = 10)
p3_b <-ggplot(aes(y = citric.acid, x= quality.cat, fill= quality.cat), data = redwines) + geom_boxplot(outlier.alpha = 1/10) + geom_boxplot() + ggtitle('Citric acidity') +  theme_light(base_size = 10)


grid.arrange(p1_a, p1_b, p2_a,p2_b, p3_a,p3_b, ncol=2) + theme_light(base_size = 10)
```

### Residual sugar

The plot of residual suggar (\@ref(fig:bivariateplotresidualsugar)) shows that the better the wine the higher the residual sugar levels. 

```{r echo=FALSE, bivariateplotresidualsugar,fig.width=8, fig.height=2, fig.cap="Residual sugar distribution per quality segment"}
#Residual sugar
p4_a <- ggplot(aes(x = residual.sugar, fill= quality.cat), data = redwines) + geom_histogram(binwidth=.1, color = "black", size= 0.25) +  scale_x_log10() + ggtitle('Residual sugar')  + theme_light(base_size = 10)
p4_b <-ggplot(aes(y = residual.sugar, x= quality.cat, fill= quality.cat), data = redwines) + geom_boxplot(outlier.alpha = 1/10) + scale_y_log10() + ggtitle('Residual sugar') +  theme_light(base_size = 10) #transformed y

grid.arrange(p4_a,p4_b, ncol=2) + theme_light(base_size = 10)
```

### Chlorides and sulfur dioxide

In the plot of the chlorides, it can be onserved that the better the wine, the lower the chloride levels. For the sulfur dioxide, either the free or the total sulfur dioxide, high levels are indicator of medium quality, whereas bad and good wine have the same low amount of sulfure dioxide.

```{r echo=FALSE,  bivarateplotschloridessulfur,fig.width=8, fig.height=6, fig.cap="Chlorides and sulfur dioxide distributions per quality segment"}
#Chlorides
p5_a <- ggplot(aes(x = chlorides, fill= quality.cat), data = redwines) + geom_histogram(binwidth=.1, color = "black", size= 0.25) +  scale_x_log10() + ggtitle('Chlorides')+ theme_light(base_size = 10)
p5_b <-ggplot(aes(y = chlorides, x= quality.cat, fill= quality.cat), data = redwines) + geom_boxplot(outlier.alpha = 1/10) + scale_y_log10() + ggtitle('Chlorides') + theme_light(base_size = 10)#transformed y

#Free sulfur dioxide
p6_a <- ggplot(aes(x = free.sulfur.dioxide, fill= quality.cat), data = redwines) + geom_histogram(binwidth=.1, color = "black", size= 0.25) +  scale_x_log10() + ggtitle('Free sulfur dioxide') + theme_light(base_size = 10)
p6_b <-ggplot(aes(y = free.sulfur.dioxide, x= quality.cat, fill= quality.cat), data = redwines) + geom_boxplot(outlier.alpha = 1/10) + scale_y_log10() + ggtitle('Free sulfur dioxide') +  theme_light(base_size = 10) #transformed y

#Total sulfur dioxide
p7_a <- ggplot(aes(x = total.sulfur.dioxide, fill= quality.cat), data = redwines) + geom_histogram(binwidth=.1, color = "black", size= 0.25) +  scale_x_log10() + ggtitle('Total sulfur dioxide') + theme_light(base_size = 10)
p7_b <-ggplot(aes(y = total.sulfur.dioxide, x= quality.cat, fill= quality.cat), data = redwines) + geom_boxplot(outlier.alpha = 1/10) + scale_y_log10() + ggtitle('Total sulfur dioxide') +  theme_light(base_size = 10)#transformed y

grid.arrange(p5_a,p5_b,p6_a,p6_b,p7_a,p7_b, ncol=2) + theme_light(base_size = 10)
```


### Density, pH, sulphates and alcohol

The next plot shows that, generally, the lower the density, the better the quality of the wine. Also, low pH levels are sign of beter quality. The higher the sulphates level, the better quality of the wine and also, good wines have higher amount of alcohol.

```{r echo=FALSE, bivariateplotsdensity, fig.width=8, fig.height=8, fig.cap="Density, pH, suplhates and alcohol distributions per quality segment"}

#Density
p8_a <- ggplot(aes(x = density, fill= quality.cat), data = redwines) + geom_histogram(binwidth=.0005, color = "black", size= 0.25) +  scale_x_log10() + ggtitle('Density')+ theme_light(base_size = 10)
p8_b <-ggplot(aes(y = density, x= quality.cat, fill= quality.cat), data = redwines) + geom_boxplot(alpha= 1, outlier.alpha = 1/10) + scale_y_log10() + ggtitle('Density')+  theme_light(base_size = 10)#transformed y

#pH
p9_a <- ggplot(aes(x = pH, fill= quality.cat), data = redwines) + geom_histogram(binwidth=.01, color = "black", size= 0.25) +  scale_x_log10() + ggtitle('pH') + theme_light(base_size = 10)
p9_b <-ggplot(aes(y = pH, x= quality.cat, fill= quality.cat), data = redwines) + geom_boxplot(alpha= 1, outlier.alpha = 1/10) + scale_y_log10() + ggtitle('pH')+ theme_light(base_size = 10)#transformed y

#Sulphates
p10_a <- ggplot(aes(x = sulphates, fill= quality.cat), data = redwines) + geom_histogram(binwidth=.05, color = "black", size= 0.25) +  scale_x_log10() + ggtitle('Sulphates')+ theme_light(base_size = 10)
p10_b <-ggplot(aes(y = sulphates, x= quality.cat, fill= quality.cat), data = redwines) + geom_boxplot(alpha= 1, outlier.alpha = 1/10) + scale_y_log10() + ggtitle('Sulphates')+  theme_light(base_size = 10)#transformed y

#Alcohol
p11_a <- ggplot(aes(x = alcohol, fill= quality.cat), data = redwines) + geom_histogram(binwidth=.01, color = "black", size= 0.25) +  scale_x_log10() + ggtitle('Alcohol')+ theme_light(base_size = 10)
p11_b <-ggplot(aes(y = alcohol, x= quality.cat, fill= quality.cat), data = redwines) + geom_boxplot(alpha= 1, outlier.alpha = 1/10) + scale_y_log10() + ggtitle('Alcohol') + theme_light(base_size = 10)#transformed y

grid.arrange(p8_a,p8_b,p9_a,p9_b,p10_a,p10_b,p11_a,p11_b, ncol=2) + theme_light(base_size = 10);
```
### Matrix of feature relationships
```{r bivariateggpairs, fig.width=7, fig.asp=1, fig.cap="Matrix of relationships between variables"}
cols_to_avoid= c("X", "quality.cat")
column_names = colnames(redwines)
cols_names = column_names[!(column_names %in% cols_to_avoid)]
ggpairs(redwines, axisLabels = 'internal',  lower = list(continous = 'points', size = 8, mapping = aes(alpha=0.1, color= "cyan3")), upper = list(continous = 'smooth', size = 8), columns=2:10) + ggplot2::theme_light(base_size = 8)
```

## Bivariate Analysis

### Talk about some of the relationships you observed in this part of the investigation. How did the feature(s) of interest vary with other features in the dataset?

### Did you observe any interesting relationships between the other features (not the main feature(s) of interest)?

### What was the strongest relationship you found?




# Multivariate Plots Section

##Correlation
### Correlation betweeen variables

In the next figure (fig.\@ref(fig:MultivariateCorrelation)) it is shown the correlation factor between the different variables in the Red Wines dataset. Significant correlation values ($|R|>0.3$) are highigtjed with stronger color density the higher the correlation value.

For the purpose of this analysis, the focus will be placed in the relationship between quality and other variables.

```{r echo=FALSE,include= TRUE, MultivariateCorrelation, fig.width=5, fig.asp=1, fig.align= 'center', fig.cap="Correlation bewteen Red Wine's dataset features"}

ggcorr_custom <- function(x, method = "pairwise", palette = "RdYlGn", cols_to_avoid = c("X", "quality.cat"), layout_exp = 0, base_size_font=7) {
  require(ggplot2)
  require(GGally)
  require(grid)
  require(gridBase)
  require(gridExtra)

  column_names = colnames(x)
  cols_names = column_names[!(column_names %in% cols_to_avoid)]

  po.nopanel <- list(theme(
    panel.background = element_blank(), 
    panel.grid.minor = element_blank(),
    panel.grid.major = element_blank(),
    axis.text.x = element_text(angle = -90)))
  
  corr <-ggcorr(data=subset(x, select = cols_names),
         label = TRUE,
         geom = "blank",
         hjust = 1,
         angle = -25,
         digits = 2,
         nbreaks = 8,
         name = "",
         label_round = 1,
         label_size = 3,
         legend.size = 7,
         layout.exp = layout_exp,
         size = 3 #argument of geom_text for the diagonals
         ) +
    geom_point(aes(size=abs(coefficient), color = breaks, 
                   alpha = round((abs(coefficient) > 0.28)*abs(coefficient), 1))) +
    scale_color_brewer(palette = "RdBu")+
    scale_alpha(range=c(0.,.7))+
    scale_size(range=c(0,9))+
    guides(fill= FALSE, color= FALSE, size = FALSE, alpha = FALSE) + 
    ggplot2::theme_minimal(base_size = base_size_font)+
    ggplot2::theme(axis.line = element_line(colour = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank()) 
return(corr)
}

corr_general <- ggcorr_custom(redwines, layout_exp = 2) #+ ggplot2::theme_light(base_size= 7)
corr_general_R <- corr_general$data
```

### Correlation between variables by quality range
Let us now analyze the correlation between the variables for each quality range in figure \@ref(fig:multivariatecorrquality). It can be seen that features are more correlated between them for *lower* quality wine. Some strong relationships between variables are kept for all quality ranges, as pH-density, pH-citric acid and ph-fixed acidity, or fixed acid-volatile acidity and fixed acid-fixed acidity. 
```{r multivariatecorrquality, fig.width=12, fig.asp=0.33, fig.cap="Correlation vs Quality"}

corr_total_1 <- ggcorr_custom(subset(redwines, quality.cat=="bad"), layout_exp = 2, base_size_font = 8)  + ggplot2:: ggtitle("Bad")

corr_total_2 <- ggcorr_custom(subset(redwines, quality.cat=="medium"), layout_exp = 2, base_size_font = 8) + ggplot2:: ggtitle("Medium")

corr_total_3 <- ggcorr_custom(subset(redwines, quality.cat=="good"), layout_exp = 2, base_size_font = 8) + ggplot2:: ggtitle("Good")



gridExtra::grid.arrange(corr_total_1, corr_total_2, corr_total_3, ncol = 3, name = "Correlation vs Quality")  +  theme(plot.title = element_text(size = 12))
# + ggplot2:: theme_light(base_size = 6)
#temp <- gridExtra::arrangeGrob(corr_total_1, corr_total_2, corr_total_3, nrow = 3, name = "Correlation vs Quality") + ggplot2:: theme_light(base_size = 10)

#grid.newpage()
#grid.draw(temp)

```

From the general correlation matrix (fig.\@ref(fig:MultivariateCorrelation)), three main variables can be selected due to their high correlation with quality: **alcohol** (R=0.5), **volatile.acidity** (R=0.4) and  **sulphates** (R=0.3). In order to see if they are suitable to perform an analysis let us explore the correlation between them and also the distribution of samples in bivariate plots in figure \@ref(fig:corrreport).

```{r corrreport, fig.width=8, fig.height=4, fig.align= 'center', fig.cap= "Correlation between alcohol, volatile acidity and sulphates"}

#fig.cap="Correlation between alcohol, volatile acidity and sulphates \\label{Correlations_comparative_from_table}"}

alpha_value = 1/10
corr_report <- ggcorr_custom(subset(redwines, select= c("volatile.acidity", "alcohol", "sulphates")), layout_exp = 1, base_size_font = 8 ) 
#c("volatile.acidity", "alcohol", "sulphates", "quality.cat","quality"))

multi1 <- ggplot(aes(x = sulphates, y = alcohol, fill= quality.cat), data = redwines)+ geom_point(alpha=alpha_value, aes(color= quality.cat))+ facet_wrap(~redwines$quality.cat) +theme_light(base_size = 8)



multi2 <- ggplot(aes(x = sulphates, y = volatile.acidity, fill= quality.cat), data = redwines)+ geom_point(alpha=alpha_value, aes(color= quality.cat))+ facet_wrap(~redwines$quality.cat) +theme_light(base_size = 8)



multi3 <- ggplot(aes(x = volatile.acidity, y = alcohol, fill= quality.cat), data = redwines)+ geom_point(alpha=alpha_value, aes(color= quality.cat))+ facet_wrap(~redwines$quality.cat) +theme_light(base_size = 8)


grid.arrange(corr_report, multi1,multi2,multi3,ncol=2, 
             layout_matrix = cbind(c(1,1,1), c(2,3,4))) + theme_light(base_size = 8);#+ ggplot2::guides(color= FALSE, fill=FALSE);

```
From plot \@ref(fig:corrreport) it is observed that there is a strong relationship between the sulphates and volatile acidity, and less strong between alcohol and volatile acidity.

Let us now explore the three variables suggested in @cortez2009modeling as the most imporant features for assessing Red Wine quality are: **sulphates**, **pH** and **total sulfur dioxide**.

```{r corrarticle, fig.width=8, fig.height=4, fig.align= 'center', fig.cap=  "Correlation between total sulfur dioxide, pH and sulphates"}


corr_article <- ggcorr_custom(subset(redwines, select= c("total.sulfur.dioxide","pH", "sulphates")) , layout_exp = 1, base_size_font = 8)# + ggplot2::theme_light(base_size= 8)
#c("total.sulfur.dioxide","pH", "sulphates", "quality.cat","quality")

multi1 <- ggplot(aes(x = sulphates, y = pH, fill= quality.cat), data = redwines)+ geom_point(alpha=alpha_value, aes(color= quality.cat))+ facet_wrap(~redwines$quality.cat) +theme_light(base_size = 8)



multi2 <- ggplot(aes(x = sulphates, y = total.sulfur.dioxide, fill= quality.cat), data = redwines)+ geom_point(alpha=alpha_value, aes(color= quality.cat))+ facet_wrap(~redwines$quality.cat) +theme_light(base_size = 8)


multi3 <- ggplot(aes(x = total.sulfur.dioxide, y = pH, fill= quality.cat), data = redwines)+ geom_point(alpha=alpha_value, aes(color= quality.cat))+ facet_wrap(~redwines$quality.cat) +theme_light(base_size = 8)



grid.newpage()
grid.arrange(corr_article, multi1,multi2,multi3,ncol=2, 
             layout_matrix = cbind(c(1,1,1), c(2,3,4)))
#http://www.sthda.com/english/wiki/ggplot2-easy-way-to-mix-multiple-graphs-on-the-same-page-r-software-and-data-visualization
#grid.arrange(bp, arrangeGrob(dp, sc), ncol = 2)
```


Figure \@ref(fig:corrreport) shows that the strongest relationship is between sulphates and pH (R=-0.2) followed by pH-total sulfur dioxide.  

From figure \@ref(fig:corrarticle) and \@ref(fig:corrreport) it can be concluded the varibles in the second figure (**sulphates**, **pH** and **total sulfur dioxide**), the ones suggested by @cortez2009modeling  are less correlated between them and lead to a more accurate analysis. 



```{r echo=FALSE, include=FALSE, Multivariate_Plots}
#NOT INCLUDED
require(GGally)
require(data.table)
tmp <- data.table(subset(redwines, quality.cat=="good"), keep.rownames=TRUE, keep.colnames= TRUE)

d <- ggpairs(data=tmp, 
             
             #diag=list(continuous="density"),
             lower= list(continuous = wrap("points", alpha = 1/5)),
             columns=c("sulphates","pH","total.sulfur.dioxide"),
             mapping = ggplot2::aes(color = quality.cat), 
             axisLabels="show") + 
    theme_light(base_size = 10)
d
#d + facet_grid(~quality.cat)
```


# Multivariate Analysis
```{r lm, fig.width=10,fig.asp=0.33}
##ggplot(aes(x = quality, y = free.sulfur.dioxide), data = redwines) + geom_point(aes(color=quality.cat),alpha=1/4, position = 'jitter')+ ggtitle(' Free SO2 and  Quality Relationship')


###############IMPORTANT###########

# GREEK LETTERS IN ANNOTATE(): PARSE=TRUE

alpha_value = 1/7

mylabel1 <- paste("rho == ", format(corr_general_R[(corr_general_R$y=='fixed.acidity') & (corr_general_R$x == 'pH'),'label'], digits = 3))

lm1 <- ggplot(aes(x = fixed.acidity, y = pH), data = redwines) + 
  geom_point(aes(color=quality.cat),alpha=alpha_value, position = 'jitter', na.rm = TRUE)+
  ggtitle('Fixed acidity vs pH')+
  stat_smooth(method = "lm", col = "red")# guides(color=FALSE)
  
lm1 <-lm1 + annotate("text",x =14,  y= 3.75,  label= mylabel1, parse=TRUE) # 3 % Add the value of r to the plot.
#lm1_title <- 'Fixed acidity vs pH'


mylabel2 <- paste("rho == ", format(corr_general_R[(corr_general_R$y=='fixed.acidity') & (corr_general_R$x == 'citric.acid'),'label'], digits = 3))

lm2 <- ggplot(aes(x = fixed.acidity, y = citric.acid), data = redwines) + 
  geom_point(aes(color=quality.cat),alpha=alpha_value, position = 'jitter', na.rm = TRUE)+
  ggtitle('Fixed acidity vs Citric acid')+
  ylim(0,1)+
  stat_smooth(method = "lm", col = "red") #+ guides(color=FALSE)
#lm2_title <- 'Fixed acidity vs Citric acid' 
lm2 <-lm2 + annotate("text",x =9,  y= 0.9,  label= mylabel2, parse=TRUE) # 3 % Add the 

lm3 <- ggplot(aes(x = volatile.acidity, y = citric.acid), data = redwines) + 
  geom_point(aes(color=quality.cat),alpha=alpha_value, position = 'jitter', na.rm = TRUE) +
  xlim(0,1) + ylim(0,1)+ 
  ggtitle('Volatile acidity vs Citric acid')+
  stat_smooth(method = "lm", col = "red") #+ guides(color=FALSE)
mylabel3 <- paste("rho == ", format(corr_general_R[(corr_general_R$y=='volatile.acidity') & (corr_general_R$x == 'citric.acid'),'label'], digits = 3))

lm3 <-lm3 + annotate("text",x =0.8,  y= 0.9,  label= mylabel3, parse=TRUE) # 3 % Add the 

##ggplot(aes(x = sulphates, y = pH, fill= quality.cat), data = redwines)+ geom_point(alpha=alpha_value, aes(color= quality.cat))+ facet_wrap(~redwines$quality.cat) +theme_light(base_size = 8)
#lm3_title <- 'Volatile acidity vs Citric acid'

# arrange the three plots in a single row
require(cowplot)
prow <- plot_grid( lm1 + theme(legend.position="none"),
           lm2 + theme(legend.position="none"),
           lm3 + theme(legend.position="none"),
           align = 'vh',
           #labels = c(lm1_title, lm2_title, lm3_title),
           #hjust = 1,
           nrow = 1
           )

#grid.arrange(lm1, lm2, lm3, ncol=3)
# extract the legend from one of the plots
# (clearly the whole thing only makes sense if all plots
# have the same legend, so we can arbitrarily pick one.)
legend <- get_legend(lm1)

# add the legend to the row we made earlier. Give it one-third of the width
# of one plot (via rel_widths).
p <- plot_grid( prow, legend, rel_widths = c(3, .3))
p
```


### Talk about some of the relationships you observed in this part of the investigation. Were there features that strengthened each other in terms of looking at your feature(s) of interest?

### Were there any interesting or surprising interactions between features?

### OPTIONAL: Did you create any models with your dataset? Discuss the strengths and limitations of your model.

------

# Final Plots and Summary

### Plot One
```{r echo=FALSE, Plot_One}

```

### Description One


### Plot Two
```{r echo=FALSE, Plot_Two}

```

### Description Two


### Plot Three
```{r echo=FALSE, Plot_Three}

```

### Description Three

------

# Reflection


## References









```{r echo=FALSE, include= FALSE, Univariate_Plots_log}

p1 <-ggplot(aes(x = fixed.acidity ), data = redwines) + geom_histogram(binwidth = .01) +  scale_x_log10() #+ theme_light(base_size = 10)

p2 <-ggplot(aes(x = volatile.acidity ), data = redwines) + geom_histogram(binwidth = .01)+  scale_x_log10() #+ theme_light(base_size = 10)

p3 <-ggplot(aes(x = citric.acid ), data = redwines) + geom_histogram(binwidth = .01)#+ theme_light(base_size = 10)

p4 <-ggplot(aes(x = residual.sugar), data = redwines) + geom_histogram(binwidth = .05) +  scale_x_log10() #+ theme_light(base_size = 10)

p5 <-ggplot(aes(x = chlorides ), data = redwines) + geom_histogram(binwidth = .01)  +  scale_x_log10()#+ theme_light

p6 <-ggplot(aes(x = free.sulfur.dioxide), data = redwines) + geom_histogram(binwidth = 0.05) +  scale_x_log10() #+ theme_light(base_size = 10)

p7 <-ggplot(aes(x = total.sulfur.dioxide), data = redwines) + geom_histogram(binwidth = 0.05) #+ theme_light(base_size = 10)

p8 <-ggplot(aes(x = density), data = redwines) + geom_histogram(binwidth = .0005) #+ theme_light(base_size = 10)



grid.arrange(p1,p2,p3,p4,p5,p6,p7,p8, ncol=4) + theme_light(base_size = 10)
```

```{r echo=FALSE, include= FALSE, message= FALSE, warning= FALSE, Univariate_Plots_1, fig.width=16, fig.height=8}
library(gridExtra)
p1 <-ggplot(aes(x = fixed.acidity ), data = redwines) + geom_histogram(binwidth=.5)# +  scale_x_log10() #+ theme_light(base_size = 10)

p2 <-ggplot(aes(x = volatile.acidity ), data = redwines) + geom_histogram(binwidth = .05)#+  scale_x_log10() #+ theme_light(base_size = 10)

p3 <-ggplot(aes(x = citric.acid ), data = redwines) + geom_histogram(binwidth = .05)#+ theme_light(base_size = 10)

p4 <-ggplot(aes(x = residual.sugar), data = redwines) + geom_histogram(binwidth = .5) #+  scale_x_log10() #+ theme_light(base_size = 10)

p5 <-ggplot(aes(x = chlorides ), data = redwines) + geom_histogram(binwidth = .01)  #+  scale_x_log10()#+ theme_light

p6 <-ggplot(aes(x = free.sulfur.dioxide), data = redwines) + geom_histogram(binwidth = 5) #+  scale_x_log10() #+ theme_light(base_size = 10)

p7 <-ggplot(aes(x = total.sulfur.dioxide), data = redwines) + geom_histogram(binwidth = 10) #+ theme_light(base_size = 10)

p8 <-ggplot(aes(x = density), data = redwines) + geom_histogram(binwidth = .0005) #+ theme_light(base_size = 10)

p9 <-ggplot(aes(x = pH ), data = redwines) + geom_histogram(binwidth = .05)  #+  scale_x_log10()#+ theme_light

p10 <-ggplot(aes(x = sulphates), data = redwines) + geom_histogram(binwidth = 0.05) #+  scale_x_log10() #+ theme_light(base_size = 10)

p11 <-ggplot(aes(x = alcohol), data = redwines) + geom_histogram(binwidth = .5) #+ theme_light(base_size = 10)

p12 <-ggplot(aes(x = quality), data = redwines) + geom_bar() #+ theme_light(base_size = 10)

grid.arrange(p1,p2,p3,p4,p5,p6,p7,p8,p9,p10,p11,p12, ncol=4) + theme_light(base_size = 10)
```
